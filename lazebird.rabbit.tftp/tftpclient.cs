using System.IO;using System.Net;using System.Net.Sockets;using static lazebird.rabbit.tftp.tftplib;namespace lazebird.rabbit.tftp{    class tftpclient    {        IPEndPoint serverEP;        int timeout = 1000;        public void get(string remoteFile, string localFile, string tftpMode)        {            int len = 0;            int packetNr = 1;            byte[] sndBuffer = CreateReqPacket(Opcodes.Read, remoteFile, tftpMode);            byte[] rcvBuffer = new byte[516];            BinaryWriter fileStream = new BinaryWriter(new FileStream(localFile, FileMode.Create, FileAccess.Write, FileShare.Read));            serverEP = new IPEndPoint(IPAddress.Any, 69);            EndPoint dataEP = (EndPoint)serverEP;            Socket tftpSocket = new Socket(serverEP.Address.AddressFamily, SocketType.Dgram, ProtocolType.Udp);            tftpSocket.SendTo(sndBuffer, sndBuffer.Length, SocketFlags.None, serverEP);            tftpSocket.ReceiveTimeout = timeout;            len = tftpSocket.ReceiveFrom(rcvBuffer, ref dataEP);            serverEP.Port = ((IPEndPoint)dataEP).Port;            while (true)            {                if (((Opcodes)rcvBuffer[1]) == Opcodes.Error)                {                    fileStream.Close();                    tftpSocket.Close();                }                if ((((rcvBuffer[2] << 8) & 0xff00) | rcvBuffer[3]) == packetNr)                {                    fileStream.Write(rcvBuffer, 4, len - 4);                    sndBuffer = CreateAckPacket(packetNr++);                    tftpSocket.SendTo(sndBuffer, sndBuffer.Length, SocketFlags.None, serverEP);                }                if (len < 516)                {                    break;                }                else                {                    len = tftpSocket.ReceiveFrom(rcvBuffer, ref dataEP);                }            }            tftpSocket.Close();            fileStream.Close();        }        public void put(string remoteFile, string localFile, string tftpMode)        {            int len = 0;            int packetNr = 0;            byte[] sndBuffer = CreateReqPacket(Opcodes.Write, remoteFile, tftpMode);            byte[] rcvBuffer = new byte[516];            BinaryReader fileStream = new BinaryReader(new FileStream(localFile, FileMode.Open, FileAccess.Read, FileShare.ReadWrite));            IPEndPoint serverEP = new IPEndPoint(IPAddress.Any, 69);            EndPoint dataEP = (EndPoint)serverEP;            Socket tftpSocket = new Socket(serverEP.Address.AddressFamily, SocketType.Dgram, ProtocolType.Udp);            tftpSocket.SendTo(sndBuffer, sndBuffer.Length, SocketFlags.None, serverEP);            tftpSocket.ReceiveTimeout = 1000;            len = tftpSocket.ReceiveFrom(rcvBuffer, ref dataEP);            serverEP.Port = ((IPEndPoint)dataEP).Port;            while (true)            {                if (((Opcodes)rcvBuffer[1]) == Opcodes.Error)                {                    fileStream.Close();                    tftpSocket.Close();                }                if ((((Opcodes)rcvBuffer[1]) == Opcodes.Ack) && (((rcvBuffer[2] << 8) & 0xff00) | rcvBuffer[3]) == packetNr)                {                    sndBuffer = CreateDataPacket(++packetNr, fileStream.ReadBytes(512));                    tftpSocket.SendTo(sndBuffer, sndBuffer.Length, SocketFlags.None, serverEP);                }                if (sndBuffer.Length < 516)                {                    break;                }                else                {                    len = tftpSocket.ReceiveFrom(rcvBuffer, ref dataEP);                }            }            tftpSocket.Close();            fileStream.Close();        }    }}